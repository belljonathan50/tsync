<html>

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>jsonS = S</title>

  <link href="libs/fonts/fonts.css" rel="stylesheet">
  <script src="libs/libINScore.js"></script>
  <script src="libs/libGUIDOEngine.js"></script>
  <script src="libs/libfaust-wasm.js"></script>
  <script src="libs/FaustLibrary.js"></script>
  <script src="libs/inscoreview.js"></script>
  <script src="libs/inscoreglue.js"></script>
  <script src="libs/libmusicxml.js"></script>
  <script src="/timesync/timesync.js"></script> 

  <style>
    body {
      margin: 20;
      background-color: black;
      color: white
    }

    .inscore {
      background-color: white;
      border-color: grey;
      width: 100%;
      height: 100%;
      font-size: 1px;
    }

    #lock {
      background-color: white;
      border-color: grey;
      width: 100%;
      height: 100%;
      font-size: 68px;
    }

    .slider {
  -webkit-appearance: none;  /* Override default CSS styles */
  appearance: none;
  width: 100%; /* Full-width */
  height: 125px; /* Specified height */
  background: #d3d3d3; /* Grey background */
  outline: none; /* Remove outline */
  opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
  -webkit-transition: .2s; /* 0.2 seconds transition on hover */
  transition: opacity .2s;
}
  </style>
</head>





<script>
  manualAdjustment = 0;
  var ts = timesync.create({
    server: '/timesync',
    interval: 10000
  });
 
  ts.on('change', function (offset) {
  });
  setInterval(function () {
    var now = new Date(ts.now());
  }, 5000);
</script> 



<body>

  <button id="lock" type="button" onclick="
           vid.play();
           vid.pause();
           this.remove();
">please click</button>
    
<center>
   <video id="vid" height="80%" width="100%" src="libs/vids/s/duf.mp4" controls playsinline></video>
<br><br>
<br>   <form>
    <label for="vol">delay adjustment</label>
    <input class="slider" type="range" id="vol" name="sik" name="sik" min="-1500" max="1500" value="0" style="color:rgb(0, 251, 21); width:600px;" oninput="
    window.manualAdjustment =parseInt(this.value); 
    ws.send('adjS ' + manualAdjustment);
    console.log('adjS ' + manualAdjustment);

    this.nextElementSibling.value = this.value + ' ms'">
    <output>0</output>
  </form>
  <br> <br>
  <br> <br>
</center>







 <script>

window.tomate=0;

  (function() {
    var HOST = location.origin.replace(/^http/, 'ws');
    window.ws = new WebSocket(HOST);
    
    var form = document.querySelector('.form');
    let vid = document.getElementById('vid');

    
    ws.onmessage = function(msg) {

      var response = msg.data;
      var words = response.split(' ');


      var first = words[0];
      // console.log('first '+ first);
      var second = words[1];
      // console.log('second '+ second);
      var third = words[2];
      // console.log('third '+ third);
      var later = parseInt(words[4]);
      // console.log('later  '+ later);
      var last = words[words.length-1];
      // console.log('last '+ last);
      var obj = JSON.parse(last); 
      


   // always update

   switch(first) {
  case "hit":
// when
  var NowClientSide = new Date(ts.now());
  var NowClientNum = NowClientSide.getTime()
  // console.log("now " + NowClientNum+ " later " + later);
  var difference = (later - NowClientNum) + manualAdjustment;
  

  setTimeout( function() { 

    // update
        if(obj.data.isPlaying=='true'){vid.play();} else {vid.pause();};
        vid.playbackRate = obj.data.rate;
        
        let resource = vid.src.split('/').pop();
        let stateresource = obj.data.tune+'.mp4';
        if (resource != stateresource) {vid.src = '/libs/vids/s/'+ obj.data.tune +'.mp4'};
        var doudou = vid.currentTime - obj.data.seek;
        // console.log("la difififififiifif " + doudou)

        if(Math.abs(doudou)> 4)
           {
            // console.log(" - - - - - - - - -grande diff - - - - - - -  "+ doudou); 
           vid.currentTime = obj.data.seek;
           } 

        else if ( Math.abs(doudou)>= 2   && Math.abs(doudou)<4   )
        {
          // console.log(" - - - - - - - - -medium diff - - - - - - -  "+ doudou); 

          if(doudou>0) {vid.playbackRate = 0.6*vid.playbackRate;
                        console.log("slow down")
                       }
          else if (doudou<0) {vid.playbackRate = 1.4*vid.playbackRate;
                        console.log("speed up")
                       }
        } 

        else if ( Math.abs(doudou)>= 0.5   && Math.abs(doudou)< 2   )
        {
          // console.log(" - - - - - - - - -PETITE diff - - - - - - -  "+ doudou); 

          if(doudou>0) {vid.playbackRate = 0.8*vid.playbackRate;
                        console.log("slow down a bit")
                       }
          else if (doudou<0) {vid.playbackRate = 1.2*vid.playbackRate;
                        console.log("speed up a bit")
                       }
        } 

        else if ( Math.abs(doudou)>= 0.15   && Math.abs(doudou)< 0.5   )
        {
          // console.log(" - - - - - - - - -PETITE diff - - - - - - -  "+ doudou); 

          if(doudou>0) {vid.playbackRate = 0.9*vid.playbackRate;
                        // console.log("slow down JUST A TINY a bit")
                       }
          else if (doudou<0) {vid.playbackRate = 1.1*vid.playbackRate;
                        // console.log("speed up JUST A TINY  bit")
                       }
        } 

        else if ( Math.abs(doudou)>= 0.05   && Math.abs(doudou)< 0.15   )
        {
          // console.log(" - - - - - - - - -MINI diff - - - - - - -  "+ doudou); 

          if(doudou>0) {vid.playbackRate = 0.95;
            // console.log("slow down JUST A TINYTINYTINYTINY a bit")
                       }
          else if (doudou<0) {vid.playbackRate = 1.05;
                        // console.log("speed up JUST A TINYTINYTINYTINY  bit")
                       }
        } 


        else if ( Math.abs(doudou)>= 0   && Math.abs(doudou) < 0.05   )
        {
          // console.log(" - - - - - - - - -on time - - - - - - -  "+ doudou); 

        } 
  

                         }, difference)

  break;

  default:
    console.log("do nothing")
} 

    };
















  







    
  }());


  

  
  </script>










<div class="inscore" id="scene">
  <pre>





/ITL/scene/cursor set rect 0.03 0.6;
/ITL/scene/cursor color 255 0 0;
/ITL/scene/cursor show 0;


sc0start = 0.1 ;
sc0end = 1 ;
sc1start = 1 ;
sc1end = 2 ;
sc2start = 2 ;
sc2end = 3 ;
sc3start = 3 ;
sc3end = 4 ;
sc4start = 4 ;
sc4end = 5 ;
sc5start = 5 ;
sc5end = 6 ;


sc0duree = $sc0end - $sc0start;
sc1duree = $sc1end - $sc1start;
sc2duree = $sc2end - $sc2start;
sc3duree = $sc3end - $sc3start;
sc4duree = $sc4end - $sc4start;
sc5duree = $sc5end - $sc5start;



/ITL/scene/sc0 set txt '0' ;
/ITL/scene/sc1 set txt '0' ;
/ITL/scene/sc2 set txt '0' ;
/ITL/scene/sc3 set txt '0' ;
/ITL/scene/sc4 set txt '0' ;
/ITL/scene/sc5 set txt '0' ;

/ITL/scene/sc* show 0 ;

#===================================================================================================================
# events declaration
#================================================================================================================= 
/ITL/scene watch START0 (
   /ITL/scene/cursor date 0,
   /ITL/scene/cursor tempo 60
  );

  /ITL/scene watch STARTX (
    /ITL/scene/cursor tempo 60
   );

/ITL/scene watch STOP0 (
    /ITL/scene/cursor tempo 0
   );

   /ITL/scene watch REWIND (
    /ITL/scene/cursor date 0,
    /ITL/scene/cursor tempo 0
   );


/ITL/scene watch START (
/ITL/scene/sync cursor sc* v relative
);

/ITL/scene watch STOP (
/ITL/scene/cursor tempo 0
);






/ITL/scene/sc0 date 	$sc0start;
/ITL/scene/sc0 duration $sc0duree;
/ITL/scene/sc1 date 	$sc1start;
/ITL/scene/sc1 duration $sc1duree;
/ITL/scene/sc2 date 	$sc2start;
/ITL/scene/sc2 duration $sc2duree;
/ITL/scene/sc3 date 	$sc3start;
/ITL/scene/sc3 duration $sc3duree;
/ITL/scene/sc4 date 	$sc4start;
/ITL/scene/sc4 duration $sc4duree;
/ITL/scene/sc5 date 	$sc5start;
/ITL/scene/sc5 duration $sc5duree;

#================================================================================================
# the score
#================================================================================================


/ITL/scene/cursor watch timeEnter $sc0start$sc0end (
/ITL/log write section 0,
/ITL/scene/javascript run "toto('bite')"
);

/ITL/scene/cursor watch timeEnter $sc1start$sc1end (
/ITL/log write section 1
);

/ITL/scene/cursor watch timeEnter $sc2start$sc2end (
/ITL/log write section 2
);

/ITL/scene/cursor watch timeEnter $sc3start$sc3end (
/ITL/log write section 3
);

/ITL/scene/cursor watch timeEnter $sc4start$sc4end (
/ITL/log write section 4
);














# UI UI UI UI UI UI UI user interface settings




/ITL/scene/cursor tempo 0;
/ITL/scene/cursor date 0;





/ITL/scene/ctrlplay set img "imgsop/play.png";
/ITL/scene/ctrlstop set img "imgsop/stop.png";
/ITL/scene/ctrlplay xorigin 1.2;
/ITL/scene/ctrlstop xorigin -1.2;
/ITL/scene/ctrl* width 0.080;
/ITL/scene/ctrl* y 0.88;
alpha = 150; 
/ITL/scene/ctrl* alpha $alpha;
/ITL/scene/ctrl* watch mouseEnter ( /ITL/scene/$self alpha 255); 
/ITL/scene/ctrl* watch mouseLeave ( /ITL/scene/$self alpha $alpha); 

CTRLPLAY = (/ITL/scene/ctrlplay push,
/ITL/log write 'ctrplay-push',
/ITL/scene/cursor tempo 60,
/ITL/scene/ctrlplay set img "imgsop/pause.png", 
/ITL/scene/ctrlplay watch mouseDown (
  /ITL/scene/cursor tempo 0,
  /ITL/scene/ctrlplay set img "imgsop/play.png",
  /ITL/log write 'ctrplay-pop',
  /ITL/scene/ctrlplay pop
)
);



/ITL/scene watch keyDown ArrowRight ( /ITL/scene event PRINTX );
/ITL/scene watch PRINTX (
 /ITL/log write "hi hi",
 /ITL/scene/ctrlplay push,
/ITL/log write 'ctrplay-push',
/ITL/scene/cursor tempo 60,
/ITL/scene/ctrlplay set img "imgsop/pause.png", 
/ITL/scene/ctrlplay watch mouseDown (
  /ITL/scene/cursor tempo 0,
  /ITL/scene/ctrlplay set img "imgsop/play.png",
  /ITL/log write 'ctrplay-pop',
  /ITL/scene/ctrlplay pop)
  );

  /ITL/scene watch keyDown ' ' ( /ITL/scene event PRINTX );
/ITL/scene watch PRINTX (
 /ITL/log write "hi hi",
 /ITL/scene/ctrlplay push,
/ITL/log write 'ctrplay-push',
/ITL/scene/cursor tempo 60,
/ITL/scene/ctrlplay set img "imgsop/pause.png", 
/ITL/scene/ctrlplay watch keyDown ' ' (
  /ITL/scene/cursor tempo 0,
  /ITL/scene/ctrlplay set img "imgsop/play.png",
  /ITL/log write 'ctrplay-pop',
  /ITL/scene/ctrlplay pop)
  );

  /ITL/scene watch keyDown ArrowLeft ( /ITL/scene event PRINTY );
  /ITL/scene watch PRINTY (
    /ITL/scene/cursor tempo 0,
       /ITL/scene/ctrlplay set img "imgsop/play.png",
       /ITL/log write 'ctrplay-pop',
       /ITL/scene/ctrlplay pop
     );


/ITL/scene/ctrlplay watch mouseDown $CTRLPLAY;

/ITL/scene/ctrlstop watch mouseDown (
/ITL/scene/cursor tempo 0,
/ITL/scene/cursor date 0,
/ITL/scene/ctrlplay pop,
/ITL/scene/ctrlplay watch mouseDown $CTRLPLAY,
/ITL/scene/ctrlplay set img "imgsop/play.png",
/ITL/scene event CUT 
);






#==================================================
# event declaration
#================================================== 





/ITL/scene watch CUT (
	/ITL/scene/shift disconnect audioOutput,
	/ITL/scene/echo disconnect audioOutput,
	/ITL/scene/vocoder disconnect audioOutput,
	/ITL/scene/reverb disconnect audioOutput,
	/ITL/scene/radio disconnect audioOutput
);

/ITL/scene watch VOCODER (
	/ITL/scene/audioInput connect vocoder,
    /ITL/scene/vocoder connect audioOutput,
	/ITL/scene/vocoder/My_Vocoder/Excitation/Freq '$1',
	/ITL/scene/vocoder/My_Vocoder/Excitation/Gain '$2',
	/ITL/scene/vocoder/My_Vocoder/Vocoder/Attack '$3',
	/ITL/scene/vocoder/My_Vocoder/Vocoder/BW '$4',
	/ITL/scene/vocoder/My_Vocoder/Vocoder/Release '$5'
);

/ITL/scene watch ECHO (
/ITL/scene/audioInput connect echo,
/ITL/scene/echo connect audioOutput,
/ITL/scene/echo/echo__1000/feedback '$1',
/ITL/scene/echo/echo__1000/millisecond '$2'
);


#==================================================
# SHIFT 1/ shifting -24 24 2/ window 50 10000 3/ xfade 1 10000 
#================================================== 


/ITL/scene watch SHIFT (
	/ITL/scene/audioInput connect shift,
    /ITL/scene/shift connect audioOutput,
	/ITL/scene/shift/Pitch_Shifter/shifting '$1',
	/ITL/scene/shift/Pitch_Shifter/window '$2',
	/ITL/scene/shift/Pitch_Shifter/xfade '$3'
);


#==================================================
# REVERB 1/ damps 0. 1. 2/ roomsize 0. 1. 3/ wet 0. 1.
#================================================== 


/ITL/scene watch REVERB (
/ITL/scene/audioInput connect reverb,
/ITL/scene/reverb connect audioOutput,
/ITL/scene/reverb/Freeverb/0x00/Damp '$1',
/ITL/scene/reverb/Freeverb/0x00/RoomSize '$2',
/ITL/scene/reverb/Freeverb/Wet '$3'
);

#==================================================
# SHIFTREVERB 1/ shifting -24 24 2/ window 50 10000 3/ xfade 1 10000 4/ damps 0. 1. 5/ roomsize 0. 1. 6/ wet 0. 1.
#================================================== 


/ITL/scene watch SHIFTREVERB (
/ITL/scene/audioInput connect shift,
/ITL/scene/shift connect reverb,
/ITL/scene/reverb connect audioOutput,
/ITL/scene/shift/Pitch_Shifter/shifting '$1',
/ITL/scene/shift/Pitch_Shifter/window 10000,
/ITL/scene/shift/Pitch_Shifter/xfade 10000,
/ITL/scene/reverb/Freeverb/0x00/Damp 0.9,
/ITL/scene/reverb/Freeverb/0x00/RoomSize 0.9,
/ITL/scene/reverb/Freeverb/0x00/Stereo_Spread 0.9,
/ITL/scene/reverb/Freeverb/Wet '$2'
);

/ITL/scene watch RADIO (
/ITL/scene/audioInput connect radio,
/ITL/scene/radio connect audioOutput,
/ITL/scene/radio/FaustDSP/Q  '$1',
/ITL/scene/radio/FaustDSP/freq  '$2'
);




#==================================================
# RADIOECHO 1/ Q 20s good     2/ freq 0 - 0.5  -  1      3/ milliseconds     4/ feedback 0 100
#==================================================

/ITL/scene watch RADIOECHO (
/ITL/scene/audioInput connect echo,
/ITL/scene/echo connect radio,
/ITL/scene/radio connect audioOutput,
/ITL/scene/radio/FaustDSP/Q  '$1',
/ITL/scene/radio/FaustDSP/freq  '$2',
/ITL/scene/echo/echo__1000/millisecond '$3',
/ITL/scene/echo/echo__1000/feedback '$4'
);





#==================================================
# faust part
#================================================== 

/ITL/scene/echo set faustw 'wasm/echo.wasm' 'wasm/echo.json';
/ITL/scene/echo/echo__1000/feedback 80;
/ITL/scene/echo/echo__1000/millisecond 80;
/ITL/scene/echo show 0;


/ITL/scene/shift set faustw 'wasm/shift.wasm' 'wasm/shift.json';
/ITL/scene/shift show 0;

/ITL/scene/vocoder set faustw 'wasm/vocoder.wasm' 'wasm/vocoder.json';
/ITL/scene/vocoder show 0;
/ITL/scene/vocoder/My_Vocoder/Excitation/Freq 50;
/ITL/scene/vocoder/My_Vocoder/Excitation/Gain 1;
/ITL/scene/vocoder/My_Vocoder/Vocoder/Attack 0.1;
/ITL/scene/vocoder/My_Vocoder/Vocoder/BW 0.13;
/ITL/scene/vocoder/My_Vocoder/Vocoder/Release 0.1;

/ITL/scene/reverb set faustw 'wasm/reverb.wasm' 'wasm/reverb.json';
/ITL/scene/reverb show 0;

/ITL/scene/eq set faustw  'wasm/eq.wasm' 'wasm/eq.json';
/ITL/scene/eq show 0;

/ITL/scene/radio set faustw 'wasm/radio.wasm' 'wasm/radio.json';
/ITL/scene/radio show 0;














#==================================================
#/ITL/scene/cursor date 5;
#
# /ITL/scene/sc100 watch show ( /ITL/scene/sc100 watch show, /ITL/scene event START );
#
#
#================================================== 





</pre>

</div> 




</body>

</html>
